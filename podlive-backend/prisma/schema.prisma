generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  unique_handle   String   @unique
  email           String   @unique
  password_hash   String
  display_name    String
  avatar_url      String?
  bio             String?
  follower_count  Int      @default(0)
  following_count Int      @default(0)
  is_verified     Boolean  @default(false)
  created_at      DateTime @default(now())
  last_seen       DateTime @default(now())

  // Relations
  hosted_sessions LiveSession[] @relation("HostSessions")
  sent_invites    StageInvite[] @relation("HostInvites")
  received_invites StageInvite[] @relation("InviteeInvites")

  followers       Follows[] @relation("UserFollowers")
  following       Follows[] @relation("UserFollowing")
  likes           Like[]
}

model Follows {
  id          String   @id @default(uuid())
  follower_id String
  following_id String
  created_at  DateTime @default(now())

  follower  User @relation("UserFollowing", fields: [follower_id], references: [id])
  following User @relation("UserFollowers", fields: [following_id], references: [id])

  @@unique([follower_id, following_id])
}

model LiveSession {
  id                String    @id @default(uuid())
  host_user_id      String
  title             String
  description       String?
  thumbnail_url     String?
  status            String    @default("scheduled") // scheduled, live, ended
  livekit_room_name String?
  viewer_count_peak Int       @default(0)
  recording_url     String?
  started_at        DateTime?
  ended_at          DateTime?
  category          String?
  like_count        Int       @default(0)
  is_processing     Boolean   @default(false)
  created_at        DateTime  @default(now())

  // Relations
  host        User          @relation("HostSessions", fields: [host_user_id], references: [id])
  invites     StageInvite[]
  chat_messages ChatMessage[]
  likes       Like[]
  subtitles   Subtitle[]
}

model Subtitle {
  id          String   @id @default(uuid())
  session_id  String
  language    String
  label       String
  vtt_url     String
  created_at  DateTime @default(now())

  session     LiveSession @relation(fields: [session_id], references: [id])
}

model Like {
  id          String   @id @default(uuid())
  user_id     String
  session_id  String
  created_at  DateTime @default(now())

  user        User        @relation(fields: [user_id], references: [id])
  session     LiveSession @relation(fields: [session_id], references: [id])

  @@unique([user_id, session_id])
}

model ChatMessage {
  id          String   @id @default(uuid())
  session_id  String
  sender_handle String
  message     String
  created_at  DateTime @default(now())

  // Relations
  session     LiveSession @relation(fields: [session_id], references: [id])
}

model StageInvite {
  id          String    @id @default(uuid())
  session_id  String
  host_id     String
  invitee_id  String
  status      String    @default("pending") // pending, accepted, rejected, ended
  invited_at  DateTime  @default(now())
  accepted_at DateTime?
  left_at     DateTime?

  // Relations
  session LiveSession @relation(fields: [session_id], references: [id])
  host    User        @relation("HostInvites", fields: [host_id], references: [id])
  invitee User        @relation("InviteeInvites", fields: [invitee_id], references: [id])
}
